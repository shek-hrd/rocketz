<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket Text Game v2 - Health & Points</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .game-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .text-frame {
            position: relative;
            width: 100%;
            height: 400px;
            border: 2px solid #333;
            background-color: white;
            overflow: hidden;
            cursor: text;
        }
        
        .text-editor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            box-sizing: border-box;
            background: transparent;
            white-space: pre;
            overflow: auto;
        }
        
        .rocket {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            transition: none;
            z-index: 10;
        }
        
        .rocket::before {
            content: '▲';
            display: block;
            font-size: 20px;
            color: #ff4444;
            text-align: center;
            line-height: 20px;
            transform-origin: center;
        }
        
        .rocket.blinking {
            animation: blink 0.3s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .info-panel {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: none;
            padding: 5px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            color: #888;
            border-radius: 3px;
            pointer-events: none;
            z-index: 20;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.8), -1px -1px 1px rgba(0,0,0,0.3);
        }
        
        .info-panel div {
            margin: 2px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .damage-text {
            position: absolute;
            color: #ff4444;
            font-weight: bold;
            font-size: 12px;
            pointer-events: none;
            z-index: 25;
            animation: fadeUp 1s forwards;
        }
        
        @keyframes fadeUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        .timer-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
            z-index: 15;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.1s ease-out;
        }
        
        .points-display {
            position: absolute;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            color: #0066cc;
            pointer-events: none;
            z-index: 12;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            transition: all 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Rocket Text Game v2 - Health & Points</h1>
        <p>Click in the text area to activate rocket mode. Fly through spaces and tabs safely, avoid letters!</p>
        
        <div class="text-frame" id="gameFrame">
            <textarea class="text-editor" id="textEditor" placeholder="Start typing..."></textarea>
            <div class="rocket hidden" id="rocket"></div>
            <div class="timer-display hidden" id="timerDisplay">0:00</div>
            <div class="points-display hidden" id="pointsDisplay">0</div>
            <div class="info-panel" id="infoPanel">
                <div>Frame: <span id="frameSize">0x0</span></div>
                <div>Mouse: <span id="mousePos">0,0</span></div>
                <div>Rocket: <span id="rocketPos">0,0</span></div>
                <div>Speed: <span id="rocketSpeed">0</span></div>
                <div>Angle: <span id="rocketAngle">0°</span></div>
                <div>Health: <span id="healthDisplay">100%</span></div>
                <div>Points: <span id="pointsDisplay">0</span></div>
            </div>
        </div>
    </div>

    <script>
        class RocketTextGameV2 {
            constructor() {
                this.gameFrame = document.getElementById('gameFrame');
                this.textEditor = document.getElementById('textEditor');
                this.rocket = document.getElementById('rocket');
                this.infoPanel = document.getElementById('infoPanel');
                
                this.rocketMode = false;
                this.rocketX = 0;
                this.rocketY = 0;
                this.rocketSpeed = 0;
                this.rocketAngle = 0;
                this.maxSpeed = 5;
                
                this.health = 100;
                this.maxHealth = 100;
                this.points = 0;
                this.safeFlightTime = 0;
                this.lastSafeTime = 0;
                
                this.keys = {
                    ArrowUp: false,
                    ArrowDown: false,
                    ArrowLeft: false,
                    ArrowRight: false
                };
                
                this.animationId = null;
                this.blinkingTimeout = null;
                
                this.init();
            }
            
            init() {
                this.textEditor.focus();
                
                this.gameFrame.addEventListener('click', (e) => this.handleFrameClick(e));
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));
                this.gameFrame.addEventListener('mousemove', (e) => this.updateMouseInfo(e));
                
                this.updateFrameInfo();
                window.addEventListener('resize', () => this.updateFrameInfo());
            }
            
            handleFrameClick(e) {
                if (!this.rocketMode) {
                    this.activateRocketMode(e);
                } else {
                    this.updateRocketPosition(e);
                }
            }
            
            activateRocketMode(e) {
                this.rocketMode = true;
                this.textEditor.blur();
                this.rocket.classList.remove('hidden');
                
                this.health = 100;
                this.points = 0;
                this.safeFlightTime = 0;
                this.lastSafeTime = Date.now();
                
                this.updateRocketPosition(e);
                this.updateHealthDisplay();
                this.startGameLoop();
                
                // Initialize continuous coordinates
                this.continuousX = this.rocketX;
                this.continuousY = this.rocketY;
            }
            
            deactivateRocketMode() {
                this.rocketMode = false;
                this.rocket.classList.add('hidden');
                this.stopGameLoop();
                this.textEditor.focus();
                
                if (this.blinkingTimeout) {
                    clearTimeout(this.blinkingTimeout);
                    this.blinkingTimeout = null;
                }
                
                this.rocket.classList.remove('blinking');
            }
            
            updateRocketPosition(e) {
                const rect = this.gameFrame.getBoundingClientRect();
                this.rocketX = e.clientX - rect.left;
                this.rocketY = e.clientY - rect.top;
                this.updateRocketDisplay();
            }
            
            handleKeyDown(e) {
                if (this.rocketMode && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    this.keys[e.key] = true;
                }
            }
            
            handleKeyUp(e) {
                if (this.rocketMode && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    this.keys[e.key] = false;
                }
                
                if (e.key === 'Escape' && this.rocketMode) {
                    this.deactivateRocketMode();
                }
            }
            
            startGameLoop() {
                if (!this.animationId) {
                    this.gameLoop();
                }
            }
            
            stopGameLoop() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }
            
            gameLoop() {
                this.updateRocket();
                this.checkTextCollision();
                this.updatePoints();
                this.updateRocketDisplay();
                this.updateInfoPanel();
                
                this.animationId = requestAnimationFrame(() => this.gameLoop());
            }
            
            updateRocket() {
                if (this.keys.ArrowLeft) {
                    this.rocketAngle = (this.rocketAngle - 5 + 360) % 360;
                }
                if (this.keys.ArrowRight) {
                    this.rocketAngle = (this.rocketAngle + 5) % 360;
                }
                
                if (this.keys.ArrowUp) {
                    this.rocketSpeed = Math.min(this.rocketSpeed + 0.2, this.maxSpeed);
                }
                if (this.keys.ArrowDown) {
                    this.rocketSpeed = Math.max(this.rocketSpeed - 0.2, 0);
                }
                
                const radians = (this.rocketAngle - 90) * Math.PI / 180;
                const deltaX = Math.cos(radians) * this.rocketSpeed;
                const deltaY = Math.sin(radians) * this.rocketSpeed;
                
                const rect = this.gameFrame.getBoundingClientRect();
                
                // Calculate new positions with continuous wrapping
                let newX = this.rocketX + deltaX;
                let newY = this.rocketY + deltaY;
                
                // Use actual frame dimensions
                const width = Math.max(1, rect.width);
                const height = Math.max(1, rect.height);
                
                // Initialize continuous position if not set
                if (this.continuousX === undefined) this.continuousX = this.rocketX;
                if (this.continuousY === undefined) this.continuousY = this.rocketY;
                
                // Update continuous position (never wraps, keeps absolute position)
                this.continuousX += deltaX;
                this.continuousY += deltaY;
                
                // Simple wrapping - when rocket goes off one side, appear on the other
                if (newX < 0) {
                    newX = width + newX; // Add instead of modulo to handle negative values
                } else if (newX >= width) {
                    newX = newX - width;
                }
                
                if (newY < 0) {
                    newY = height + newY; // Add instead of modulo to handle negative values
                } else if (newY >= height) {
                    newY = newY - height;
                }
                
                // Ensure values are within bounds
                newX = Math.max(0, Math.min(width - 1, newX));
                newY = Math.max(0, Math.min(height - 1, newY));
                
                this.rocketX = newX;
                this.rocketY = newY;
            }
            
            checkTextCollision() {
                if (!this.rocketMode) return;
                
                const text = this.textEditor.value;
                if (!text) {
                    // Empty text area is completely safe
                    this.health = Math.min(this.health + 0.5, this.maxHealth);
                    this.updateHealthDisplay();
                    return;
                }
                
                // Get character position under rocket
                const charPos = this.getCharPositionAt(this.rocketX, this.rocketY);
                
                if (charPos === null) {
                    // If no character at position (empty space or outside text), it's safe
                    this.health = Math.min(this.health + 0.5, this.maxHealth);
                    this.updateHealthDisplay();
                    return;
                }
                
                // Ensure charPos is within bounds
                if (charPos < 0 || charPos >= text.length) {
                    // Out of bounds is safe
                    this.health = Math.min(this.health + 0.5, this.maxHealth);
                    this.updateHealthDisplay();
                    return;
                }
                
                const char = text[charPos];
                
                // Safe characters: spaces, tabs, and newlines
                const isSafe = char === ' ' || char === '\t' || char === '\n';
                
                if (isSafe) {
                    // Recover health when flying safely
                    this.health = Math.min(this.health + 0.5, this.maxHealth);
                    this.updateHealthDisplay();
                } else {
                    // Take damage when hitting letters
                    this.takeDamage(2);
                }
            }
            
            getCharPositionAt(x, y) {
                const textarea = this.textEditor;
                const rect = textarea.getBoundingClientRect();
                const frameRect = this.gameFrame.getBoundingClientRect();
                
                // Calculate relative position within textarea
                const relX = x - (rect.left - frameRect.left);
                const relY = y - (rect.top - frameRect.top);
                
                // Get textarea metrics
                const style = window.getComputedStyle(textarea);
                const fontSize = parseInt(style.fontSize);
                const lineHeight = fontSize * 1.4; // Approximate line height
                const charWidth = fontSize * 0.6; // Approximate char width
                
                const col = Math.floor(relX / charWidth);
                const row = Math.floor(relY / lineHeight);
                
                // Get text lines
                const lines = textarea.value.split('\n');
                
                // Handle edge cases where rocket is outside text area
                if (row < 0 || row >= lines.length || col < 0) {
                    return null;
                }
                
                const line = lines[row];
                if (col >= line.length) {
                    // If beyond text, treat as safe space
                    return null;
                }
                
                // Calculate absolute character position
                let charPos = 0;
                for (let i = 0; i < row; i++) {
                    charPos += lines[i].length + 1; // +1 for newline
                }
                charPos += col;
                
                return charPos;
            }
            
            takeDamage(amount) {
                this.health -= amount;
                this.updateHealthDisplay();
                
                // Show damage effect
                this.showDamageText(amount);
                
                // Start blinking if health is low
                if (this.health <= 30 && !this.rocket.classList.contains('blinking')) {
                    this.rocket.classList.add('blinking');
                }
                
                if (this.health <= 0) {
                    this.deactivateRocketMode();
                }
            }
            
            showDamageText(damage) {
                const damageEl = document.createElement('div');
                damageEl.className = 'damage-text';
                damageEl.textContent = `-${damage}`;
                damageEl.style.left = `${this.rocketX}px`;
                damageEl.style.top = `${this.rocketY - 20}px`;
                
                this.gameFrame.appendChild(damageEl);
                
                setTimeout(() => {
                    if (damageEl.parentNode) {
                        damageEl.parentNode.removeChild(damageEl);
                    }
                }, 1000);
            }
            
            updatePoints() {
                if (this.rocketSpeed > 0) {
                    this.safeFlightTime += 16; // ~16ms per frame at 60fps
                    this.points = Math.floor(this.safeFlightTime / 100);
                }
            }
            
            updateHealthDisplay() {
                // Update rocket opacity based on health
                this.rocket.style.opacity = this.health / 100;
            }
            
            updateRocketDisplay() {
                this.rocket.style.left = `${this.rocketX - 10}px`;
                this.rocket.style.top = `${this.rocketY - 10}px`;
                this.rocket.style.transform = `rotate(${this.rocketAngle}deg)`;
            }
            
            
            updateFrameInfo() {
                const rect = this.gameFrame.getBoundingClientRect();
                document.getElementById('frameSize').textContent = `${Math.round(rect.width)}x${Math.round(rect.height)}`;
            }
            
            updateMouseInfo(e) {
                if (this.rocketMode) {
                    const rect = this.gameFrame.getBoundingClientRect();
                    const x = Math.round(e.clientX - rect.left);
                    const y = Math.round(e.clientY - rect.top);
                    document.getElementById('mousePos').textContent = `${x},${y}`;
                }
            }
            
            updateInfoPanel() {
                document.getElementById('rocketPos').textContent = `${Math.round(this.rocketX)},${Math.round(this.rocketY)}`;
                document.getElementById('rocketSpeed').textContent = this.rocketSpeed.toFixed(1);
                document.getElementById('rocketAngle').textContent = `${this.rocketAngle}°`;
                document.getElementById('healthDisplay').textContent = `${Math.round(this.health)}%`;
                document.getElementById('pointsDisplay').textContent = this.points;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new RocketTextGameV2();
        });
    </script>
    <div style="position: fixed; bottom: 10px; left: 10px; font-size: 10px; color: #999; font-family: Arial, sans-serif;">
        Changes: Fixed clock positioning - rests above rocket on full stop, drags half-behind when coasting, further behind when accelerating, returns above when stopping
    </div>
</body>
</html>